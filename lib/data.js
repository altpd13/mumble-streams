var protobufjs = require('protobufjs'),
    util = require('util'),
    Transform = require('stream').Transform;

var nameById = {
    0: 'Version',
    1: 'UDPTunnel',
    2: 'Authenticate',
    3: 'Ping',
    4: 'Reject',
    5: 'ServerSync',
    6: 'ChannelRemove',
    7: 'ChannelState',
    8: 'UserRemove',
    9: 'UserState',
    10: 'BanList',
    11: 'TextMessage',
    12: 'PermissionDenied',
    13: 'ACL',
    14: 'QueryUsers',
    15: 'CryptSetup',
    16: 'ContextActionModify',
    17: 'ContextAction',
    18: 'UserList',
    19: 'VoiceTarget',
    20: 'PermissionQuery',
    21: 'CodecVersion',
    22: 'UserStats',
    23: 'RequestBlob',
    24: 'ServerConfig',
    25: 'SuggestConfig',
    26: 'WebRTC',
    27: 'IceCandidate',
    28: 'TalkingState'
};
var idByName = {};
for (var id in nameById) {
	idByName[nameById[id]] = id;
}

// Explicitly reading with readFileSync to support brfs
var mumbleProto = Buffer("Ly8gQ29weXJpZ2h0IDIwMDUtMjAxOCBUaGUgTXVtYmxlIERldmVsb3BlcnMuIEFsbCByaWdodHMgcmVzZXJ2ZWQuCi8vIFVzZSBvZiB0aGlzIHNvdXJjZSBjb2RlIGlzIGdvdmVybmVkIGJ5IGEgQlNELXN0eWxlIGxpY2Vuc2UKLy8gdGhhdCBjYW4gYmUgZm91bmQgaW4gdGhlIExJQ0VOU0UgZmlsZSBhdCB0aGUgcm9vdCBvZiB0aGUKLy8gTXVtYmxlIHNvdXJjZSB0cmVlIG9yIGF0IDxodHRwczovL3d3dy5tdW1ibGUuaW5mby9MSUNFTlNFPi4KCnBhY2thZ2UgTXVtYmxlUHJvdG87CgpvcHRpb24gb3B0aW1pemVfZm9yID0gU1BFRUQ7CgptZXNzYWdlIFZlcnNpb24gewoJLy8gMi1ieXRlIE1ham9yLCAxLWJ5dGUgTWlub3IgYW5kIDEtYnl0ZSBQYXRjaCB2ZXJzaW9uIG51bWJlci4KCW9wdGlvbmFsIHVpbnQzMiB2ZXJzaW9uID0gMTsKCS8vIENsaWVudCByZWxlYXNlIG5hbWUuCglvcHRpb25hbCBzdHJpbmcgcmVsZWFzZSA9IDI7CgkvLyBDbGllbnQgT1MgbmFtZS4KCW9wdGlvbmFsIHN0cmluZyBvcyA9IDM7CgkvLyBDbGllbnQgT1MgdmVyc2lvbi4KCW9wdGlvbmFsIHN0cmluZyBvc192ZXJzaW9uID0gNDsKfQoKLy8gTm90IHVzZWQuIE5vdCBldmVuIGZvciB0dW5uZWxpbmcgVURQIHRocm91Z2ggVENQLgptZXNzYWdlIFVEUFR1bm5lbCB7CgkvLyBOb3QgdXNlZC4KCXJlcXVpcmVkIGJ5dGVzIHBhY2tldCA9IDE7Cn0KCi8vIFVzZWQgYnkgdGhlIGNsaWVudCB0byBzZW5kIHRoZSBhdXRoZW50aWNhdGlvbiBjcmVkZW50aWFscyB0byB0aGUgc2VydmVyLgptZXNzYWdlIEF1dGhlbnRpY2F0ZSB7CgkvLyBVVEYtOCBlbmNvZGVkIHVzZXJuYW1lLgoJb3B0aW9uYWwgc3RyaW5nIHVzZXJuYW1lID0gMTsKCS8vIFNlcnZlciBvciB1c2VyIHBhc3N3b3JkLgoJb3B0aW9uYWwgc3RyaW5nIHBhc3N3b3JkID0gMjsKCS8vIEFkZGl0aW9uYWwgYWNjZXNzIHRva2VucyBmb3Igc2VydmVyIEFDTCBncm91cHMuCglyZXBlYXRlZCBzdHJpbmcgdG9rZW5zID0gMzsKCS8vIEEgbGlzdCBvZiBDRUxUIGJpdHN0cmVhbSB2ZXJzaW9uIGNvbnN0YW50cyBzdXBwb3J0ZWQgYnkgdGhlIGNsaWVudC4KCXJlcGVhdGVkIGludDMyIGNlbHRfdmVyc2lvbnMgPSA0OwoJb3B0aW9uYWwgYm9vbCBvcHVzID0gNSBbZGVmYXVsdCA9IGZhbHNlXTsKCS8vIFdoZXRoZXIgdG8gdXNlIFdlYlJUQyBpbnN0ZWFkIG9mIG5hdGl2ZSBVRFAgcGFja2V0cy4KCW9wdGlvbmFsIGJvb2wgd2VicnRjID0gNiBbZGVmYXVsdCA9IGZhbHNlXTsKfQoKLy8gU2VudCBieSB0aGUgY2xpZW50IHRvIG5vdGlmeSB0aGUgc2VydmVyIHRoYXQgdGhlIGNsaWVudCBpcyBzdGlsbCBhbGl2ZS4KLy8gU2VydmVyIG11c3QgcmVwbHkgdG8gdGhlIHBhY2tldCB3aXRoIHRoZSBzYW1lIHRpbWVzdGFtcCBhbmQgaXRzIG93bgovLyBnb29kL2xhdGUvbG9zdC9yZXN5bmMgbnVtYmVycy4gTm9uZSBvZiB0aGUgZmllbGRzIGlzIHN0cmljdGx5IHJlcXVpcmVkLgptZXNzYWdlIFBpbmcgewoJLy8gQ2xpZW50IHRpbWVzdGFtcC4gU2VydmVyIHNob3VsZCBub3QgYXR0ZW1wdCB0byBkZWNvZGUuCglvcHRpb25hbCB1aW50NjQgdGltZXN0YW1wID0gMTsKCS8vIFRoZSBhbW91bnQgb2YgZ29vZCBwYWNrZXRzIHJlY2VpdmVkLgoJb3B0aW9uYWwgdWludDMyIGdvb2QgPSAyOwoJLy8gVGhlIGFtb3VudCBvZiBsYXRlIHBhY2tldHMgcmVjZWl2ZWQuCglvcHRpb25hbCB1aW50MzIgbGF0ZSA9IDM7CgkvLyBUaGUgYW1vdW50IG9mIHBhY2tldHMgbmV2ZXIgcmVjZWl2ZWQuCglvcHRpb25hbCB1aW50MzIgbG9zdCA9IDQ7CgkvLyBUaGUgYW1vdW50IG9mIG5vbmNlIHJlc3luY3MuCglvcHRpb25hbCB1aW50MzIgcmVzeW5jID0gNTsKCS8vIFRoZSB0b3RhbCBhbW91bnQgb2YgVURQIHBhY2tldHMgcmVjZWl2ZWQuCglvcHRpb25hbCB1aW50MzIgdWRwX3BhY2tldHMgPSA2OwoJLy8gVGhlIHRvdGFsIGFtb3VudCBvZiBUQ1AgcGFja2V0cyByZWNlaXZlZC4KCW9wdGlvbmFsIHVpbnQzMiB0Y3BfcGFja2V0cyA9IDc7CgkvLyBVRFAgcGluZyBhdmVyYWdlLgoJb3B0aW9uYWwgZmxvYXQgdWRwX3BpbmdfYXZnID0gODsKCS8vIFVEUCBwaW5nIHZhcmlhbmNlLgoJb3B0aW9uYWwgZmxvYXQgdWRwX3BpbmdfdmFyID0gOTsKCS8vIFRDUCBwaW5nIGF2ZXJhZ2UuCglvcHRpb25hbCBmbG9hdCB0Y3BfcGluZ19hdmcgPSAxMDsKCS8vIFRDUCBwaW5nIHZhcmlhbmNlLgoJb3B0aW9uYWwgZmxvYXQgdGNwX3BpbmdfdmFyID0gMTE7Cn0KCi8vIFNlbnQgYnkgdGhlIHNlcnZlciB3aGVuIGl0IHJlamVjdHMgdGhlIHVzZXIgY29ubmVjdGlvbi4KbWVzc2FnZSBSZWplY3QgewoJZW51bSBSZWplY3RUeXBlIHsKCQkvLyBUaGUgcmVqZWN0aW9uIHJlYXNvbiBpcyB1bmtub3duIChkZXRhaWxzIHNob3VsZCBiZSBhdmFpbGFibGUKCQkvLyBpbiBSZWplY3QucmVhc29uKS4KCQlOb25lID0gMDsKCQkvLyBUaGUgY2xpZW50IGF0dGVtcHRlZCB0byBjb25uZWN0IHdpdGggYW4gaW5jb21wYXRpYmxlIHZlcnNpb24uCgkJV3JvbmdWZXJzaW9uID0gMTsKCQkvLyBUaGUgdXNlciBuYW1lIHN1cHBsaWVkIGJ5IHRoZSBjbGllbnQgd2FzIGludmFsaWQuCgkJSW52YWxpZFVzZXJuYW1lID0gMjsKCQkvLyBUaGUgY2xpZW50IGF0dGVtcHRlZCB0byBhdXRoZW50aWNhdGUgYXMgYSB1c2VyIHdpdGggYSBwYXNzd29yZCBidXQgaXQKCQkvLyB3YXMgd3JvbmcuCgkJV3JvbmdVc2VyUFcgPSAzOwoJCS8vIFRoZSBjbGllbnQgYXR0ZW1wdGVkIHRvIGNvbm5lY3QgdG8gYSBwYXNzd29yZGVkIHNlcnZlciBidXQgdGhlIHBhc3N3b3JkCgkJLy8gd2FzIHdyb25nLgoJCVdyb25nU2VydmVyUFcgPSA0OwoJCS8vIFN1cHBsaWVkIHVzZXJuYW1lIGlzIGFscmVhZHkgaW4gdXNlLgoJCVVzZXJuYW1lSW5Vc2UgPSA1OwoJCS8vIFNlcnZlciBpcyBjdXJyZW50bHkgZnVsbCBhbmQgY2Fubm90IGFjY2VwdCBtb3JlIHVzZXJzLgoJCVNlcnZlckZ1bGwgPSA2OwoJCS8vIFRoZSB1c2VyIGRpZCBub3QgcHJvdmlkZSBhIGNlcnRpZmljYXRlIGJ1dCBvbmUgaXMgcmVxdWlyZWQuCgkJTm9DZXJ0aWZpY2F0ZSA9IDc7CgkJQXV0aGVudGljYXRvckZhaWwgPSA4OwoJfQoJLy8gUmVqZWN0aW9uIHR5cGUuCglvcHRpb25hbCBSZWplY3RUeXBlIHR5cGUgPSAxOwoJLy8gSHVtYW4gcmVhZGFibGUgcmVqZWN0aW9uIHJlYXNvbi4KCW9wdGlvbmFsIHN0cmluZyByZWFzb24gPSAyOwp9CgovLyBTZXJ2ZXJTeW5jIG1lc3NhZ2UgaXMgc2VudCBieSB0aGUgc2VydmVyIHdoZW4gaXQgaGFzIGF1dGhlbnRpY2F0ZWQgdGhlIHVzZXIKLy8gYW5kIGZpbmlzaGVkIHN5bmNocm9uaXppbmcgdGhlIHNlcnZlciBzdGF0ZS4KbWVzc2FnZSBTZXJ2ZXJTeW5jIHsKCS8vIFRoZSBzZXNzaW9uIG9mIHRoZSBjdXJyZW50IHVzZXIuCglvcHRpb25hbCB1aW50MzIgc2Vzc2lvbiA9IDE7CgkvLyBNYXhpbXVtIGJhbmR3aWR0aCB0aGF0IHRoZSB1c2VyIHNob3VsZCB1c2UuCglvcHRpb25hbCB1aW50MzIgbWF4X2JhbmR3aWR0aCA9IDI7CgkvLyBTZXJ2ZXIgd2VsY29tZSB0ZXh0LgoJb3B0aW9uYWwgc3RyaW5nIHdlbGNvbWVfdGV4dCA9IDM7CgkvLyBDdXJyZW50IHVzZXIgcGVybWlzc2lvbnMgaW4gdGhlIHJvb3QgY2hhbm5lbC4KCW9wdGlvbmFsIHVpbnQ2NCBwZXJtaXNzaW9ucyA9IDQ7Cn0KCi8vIFNlbnQgYnkgdGhlIGNsaWVudCB3aGVuIGl0IHdhbnRzIGEgY2hhbm5lbCByZW1vdmVkLiBTZW50IGJ5IHRoZSBzZXJ2ZXIgd2hlbgovLyBhIGNoYW5uZWwgaGFzIGJlZW4gcmVtb3ZlZCBhbmQgY2xpZW50cyBzaG91bGQgYmUgbm90aWZpZWQuCm1lc3NhZ2UgQ2hhbm5lbFJlbW92ZSB7CglyZXF1aXJlZCB1aW50MzIgY2hhbm5lbF9pZCA9IDE7Cn0KCi8vIFVzZWQgdG8gY29tbXVuaWNhdGUgY2hhbm5lbCBwcm9wZXJ0aWVzIGJldHdlZW4gdGhlIGNsaWVudCBhbmQgdGhlIHNlcnZlci4KLy8gU2VudCBieSB0aGUgc2VydmVyIGR1cmluZyB0aGUgbG9naW4gcHJvY2VzcyBvciB3aGVuIGNoYW5uZWwgcHJvcGVydGllcyBhcmUKLy8gdXBkYXRlZC4gQ2xpZW50IG1heSB1c2UgdGhpcyBtZXNzYWdlIHRvIHVwZGF0ZSBzYWlkIGNoYW5uZWwgcHJvcGVydGllcy4KbWVzc2FnZSBDaGFubmVsU3RhdGUgewoJLy8gVW5pcXVlIElEIGZvciB0aGUgY2hhbm5lbCB3aXRoaW4gdGhlIHNlcnZlci4KCW9wdGlvbmFsIHVpbnQzMiBjaGFubmVsX2lkID0gMTsKCS8vIGNoYW5uZWxfaWQgb2YgdGhlIHBhcmVudCBjaGFubmVsLgoJb3B0aW9uYWwgdWludDMyIHBhcmVudCA9IDI7CgkvLyBVVEYtOCBlbmNvZGVkIGNoYW5uZWwgbmFtZS4KCW9wdGlvbmFsIHN0cmluZyBuYW1lID0gMzsKCS8vIEEgY29sbGVjdGlvbiBvZiBjaGFubmVsIGlkIHZhbHVlcyBvZiB0aGUgbGlua2VkIGNoYW5uZWxzLiBBYnNlbnQgZHVyaW5nCgkvLyB0aGUgZmlyc3QgY2hhbm5lbCBsaXN0aW5nLgoJcmVwZWF0ZWQgdWludDMyIGxpbmtzID0gNDsKCS8vIFVURi04IGVuY29kZWQgY2hhbm5lbCBkZXNjcmlwdGlvbi4gT25seSBpZiB0aGUgZGVzY3JpcHRpb24gaXMgbGVzcyB0aGFuCgkvLyAxMjggYnl0ZXMKCW9wdGlvbmFsIHN0cmluZyBkZXNjcmlwdGlvbiA9IDU7CgkvLyBBIGNvbGxlY3Rpb24gb2YgY2hhbm5lbF9pZCB2YWx1ZXMgdGhhdCBzaG91bGQgYmUgYWRkZWQgdG8gbGlua3MuCglyZXBlYXRlZCB1aW50MzIgbGlua3NfYWRkID0gNjsKCS8vIEEgY29sbGVjdGlvbiBvZiBjaGFubmVsX2lkIHZhbHVlcyB0aGF0IHNob3VsZCBiZSByZW1vdmVkIGZyb20gbGlua3MuCglyZXBlYXRlZCB1aW50MzIgbGlua3NfcmVtb3ZlID0gNzsKCS8vIFRydWUgaWYgdGhlIGNoYW5uZWwgaXMgdGVtcG9yYXJ5LgoJb3B0aW9uYWwgYm9vbCB0ZW1wb3JhcnkgPSA4IFtkZWZhdWx0ID0gZmFsc2VdOwoJLy8gUG9zaXRpb24gd2VpZ2h0IHRvIHR3ZWFrIHRoZSBjaGFubmVsIHBvc2l0aW9uIGluIHRoZSBjaGFubmVsIGxpc3QuCglvcHRpb25hbCBpbnQzMiBwb3NpdGlvbiA9IDkgW2RlZmF1bHQgPSAwXTsKCS8vIFNIQTEgaGFzaCBvZiB0aGUgZGVzY3JpcHRpb24gaWYgdGhlIGRlc2NyaXB0aW9uIGlzIDEyOCBieXRlcyBvciBtb3JlLgoJb3B0aW9uYWwgYnl0ZXMgZGVzY3JpcHRpb25faGFzaCA9IDEwOwoJLy8gTWF4aW11bSBudW1iZXIgb2YgdXNlcnMgYWxsb3dlZCBpbiB0aGUgY2hhbm5lbC4gSWYgdGhpcyB2YWx1ZSBpcyB6ZXJvLAoJLy8gdGhlIG1heGltdW0gbnVtYmVyIG9mIHVzZXJzIGFsbG93ZWQgaW4gdGhlIGNoYW5uZWwgaXMgZ2l2ZW4gYnkgdGhlCgkvLyBzZXJ2ZXIncyAidXNlcnNwZXJjaGFubmVsIiBzZXR0aW5nLgoJb3B0aW9uYWwgdWludDMyIG1heF91c2VycyA9IDExOwp9CgovLyBVc2VkIHRvIGNvbW11bmljYXRlIHVzZXIgbGVhdmluZyBvciBiZWluZyBraWNrZWQuIE1heSBiZSBzZW50IGJ5IHRoZSBjbGllbnQKLy8gd2hlbiBpdCBhdHRlbXB0cyB0byBraWNrIGEgdXNlci4gU2VudCBieSB0aGUgc2VydmVyIHdoZW4gaXQgaW5mb3JtcyB0aGUKLy8gY2xpZW50cyB0aGF0IGEgdXNlciBpcyBub3QgcHJlc2VudCBhbnltb3JlLgptZXNzYWdlIFVzZXJSZW1vdmUgewoJLy8gVGhlIHVzZXIgd2hvIGlzIGJlaW5nIGtpY2tlZCwgaWRlbnRpZmllZCBieSB0aGVpciBzZXNzaW9uLCBub3QgcHJlc2VudAoJLy8gd2hlbiBubyBvbmUgaXMgYmVpbmcga2lja2VkLgoJcmVxdWlyZWQgdWludDMyIHNlc3Npb24gPSAxOwoJLy8gVGhlIHVzZXIgd2hvIGluaXRpYXRlZCB0aGUgcmVtb3ZhbC4gRWl0aGVyIHRoZSB1c2VyIHdobyBwZXJmb3JtcyB0aGUga2ljawoJLy8gb3IgdGhlIHVzZXIgd2hvIGlzIGN1cnJlbnRseSBsZWF2aW5nLgoJb3B0aW9uYWwgdWludDMyIGFjdG9yID0gMjsKCS8vIFJlYXNvbiBmb3IgdGhlIGtpY2ssIHN0b3JlZCBhcyB0aGUgYmFuIHJlYXNvbiBpZiB0aGUgdXNlciBpcyBiYW5uZWQuCglvcHRpb25hbCBzdHJpbmcgcmVhc29uID0gMzsKCS8vIFRydWUgaWYgdGhlIGtpY2sgc2hvdWxkIHJlc3VsdCBpbiBhIGJhbi4KCW9wdGlvbmFsIGJvb2wgYmFuID0gNDsKfQoKLy8gU2VudCBieSB0aGUgc2VydmVyIHdoZW4gaXQgY29tbXVuaWNhdGVzIG5ldyBhbmQgY2hhbmdlZCB1c2VycyB0byBjbGllbnQuCi8vIEZpcnN0IHNlZW4gZHVyaW5nIGxvZ2luIHByb2NlZHVyZS4gTWF5IGJlIHNlbnQgYnkgdGhlIGNsaWVudCB3aGVuIGl0IHdpc2hlcwovLyB0byBhbHRlciBpdHMgc3RhdGUuCm1lc3NhZ2UgVXNlclN0YXRlIHsKCS8vIFVuaXF1ZSB1c2VyIHNlc3Npb24gSUQgb2YgdGhlIHVzZXIgd2hvc2Ugc3RhdGUgdGhpcyBpcywgbWF5IGNoYW5nZSBvbgoJLy8gcmVjb25uZWN0LgoJb3B0aW9uYWwgdWludDMyIHNlc3Npb24gPSAxOwoJLy8gVGhlIHNlc3Npb24gb2YgdGhlIHVzZXIgd2hvIGlzIHVwZGF0aW5nIHRoaXMgdXNlci4KCW9wdGlvbmFsIHVpbnQzMiBhY3RvciA9IDI7CgkvLyBVc2VyIG5hbWUsIFVURi04IGVuY29kZWQuCglvcHRpb25hbCBzdHJpbmcgbmFtZSA9IDM7CgkvLyBSZWdpc3RlcmVkIHVzZXIgSUQgaWYgdGhlIHVzZXIgaXMgcmVnaXN0ZXJlZC4KCW9wdGlvbmFsIHVpbnQzMiB1c2VyX2lkID0gNDsKCS8vIENoYW5uZWwgb24gd2hpY2ggdGhlIHVzZXIgaXMuCglvcHRpb25hbCB1aW50MzIgY2hhbm5lbF9pZCA9IDU7CgkvLyBUcnVlIGlmIHRoZSB1c2VyIGlzIG11dGVkIGJ5IGFkbWluLgoJb3B0aW9uYWwgYm9vbCBtdXRlID0gNjsKCS8vIFRydWUgaWYgdGhlIHVzZXIgaXMgZGVhZmVuZWQgYnkgYWRtaW4uCglvcHRpb25hbCBib29sIGRlYWYgPSA3OwoJLy8gVHJ1ZSBpZiB0aGUgdXNlciBoYXMgYmVlbiBzdXBwcmVzc2VkIGZyb20gdGFsa2luZyBieSBhIHJlYXNvbiBvdGhlciB0aGFuCgkvLyBiZWluZyBtdXRlZC4KCW9wdGlvbmFsIGJvb2wgc3VwcHJlc3MgPSA4OwoJLy8gVHJ1ZSBpZiB0aGUgdXNlciBoYXMgbXV0ZWQgc2VsZi4KCW9wdGlvbmFsIGJvb2wgc2VsZl9tdXRlID0gOTsKCS8vIFRydWUgaWYgdGhlIHVzZXIgaGFzIGRlYWZlbmVkIHNlbGYuCglvcHRpb25hbCBib29sIHNlbGZfZGVhZiA9IDEwOwoJLy8gVXNlciBpbWFnZSBpZiBpdCBpcyBsZXNzIHRoYW4gMTI4IGJ5dGVzLgoJb3B0aW9uYWwgYnl0ZXMgdGV4dHVyZSA9IDExOwoJLy8gVGhlIHBvc2l0aW9uYWwgYXVkaW8gcGx1Z2luIGlkZW50aWZpZXIuCgkvLyBQb3NpdGlvbmFsIGF1ZGlvIGluZm9ybWF0aW9uIGlzIG9ubHkgc2VudCB0byB1c2VycyB3aG8gc2hhcmUKCS8vIGlkZW50aWNhbCBwbHVnaW4gY29udGV4dHMuCgkvLwoJLy8gVGhpcyB2YWx1ZSBpcyBub3QgdHJhc21pdHRlZCB0byBjbGllbnRzLgoJb3B0aW9uYWwgYnl0ZXMgcGx1Z2luX2NvbnRleHQgPSAxMjsKCS8vIFRoZSB1c2VyJ3MgcGx1Z2luLXNwZWNpZmljIGlkZW50aXR5LgoJLy8gVGhpcyB2YWx1ZSBpcyBub3QgdHJhbnNtaXR0ZWQgdG8gY2xpZW50cy4KCW9wdGlvbmFsIHN0cmluZyBwbHVnaW5faWRlbnRpdHkgPSAxMzsKCS8vIFVzZXIgY29tbWVudCBpZiBpdCBpcyBsZXNzIHRoYW4gMTI4IGJ5dGVzLgoJb3B0aW9uYWwgc3RyaW5nIGNvbW1lbnQgPSAxNDsKCS8vIFRoZSBoYXNoIG9mIHRoZSB1c2VyIGNlcnRpZmljYXRlLgoJb3B0aW9uYWwgc3RyaW5nIGhhc2ggPSAxNTsKCS8vIFNIQTEgaGFzaCBvZiB0aGUgdXNlciBjb21tZW50IGlmIGl0IDEyOCBieXRlcyBvciBtb3JlLgoJb3B0aW9uYWwgYnl0ZXMgY29tbWVudF9oYXNoID0gMTY7CgkvLyBTSEExIGhhc2ggb2YgdGhlIHVzZXIgcGljdHVyZSBpZiBpdCAxMjggYnl0ZXMgb3IgbW9yZS4KCW9wdGlvbmFsIGJ5dGVzIHRleHR1cmVfaGFzaCA9IDE3OwoJLy8gVHJ1ZSBpZiB0aGUgdXNlciBpcyBhIHByaW9yaXR5IHNwZWFrZXIuCglvcHRpb25hbCBib29sIHByaW9yaXR5X3NwZWFrZXIgPSAxODsKCS8vIFRydWUgaWYgdGhlIHVzZXIgaXMgY3VycmVudGx5IHJlY29yZGluZy4KCW9wdGlvbmFsIGJvb2wgcmVjb3JkaW5nID0gMTk7CgkvLyBVbmlxdWUgU1NSQyBmcm9tIHdoaWNoIHRoZSB1c2VyJ3MgYXVkaW8gaXMgc2VudCB3aGVuIHVzaW5nIFdlYlJUQy4KCS8vCgkvLyBBcyBvcHBvc2VkIHRvIGBzZXNzaW9uYCwgdGhpcyB2YWx1ZSBtdXN0IG5vdCBiZSBtb25vdG9uaWNhbGx5IGluY3JlYXNpbmcKCS8vIGJ1dCBtdXN0IGluc3RlYWQgYmUgcmUtdXNlZCB3aGVyZSBwb3NzaWJsZSAoaS5lLiBhZnRlciBhIHVzZXIgZGlzY29ubmVjdHMpLgoJLy8gVGhlIFdlYlJUQyBpbXBsZW1lbnRhdGlvbiBtdXN0IGtlZXAgdHJhY2sgb2YgYWxsIFNTUkNzIGV2ZXIgdXNlZCBmb3IgdGhlCgkvLyBlbnRpcmV0eSBvZiB0aGUgV2ViUlRDIHNlc3Npb24sIHNvIHRoYXQgbnVtYmVyIG5lZWRzIHRvIGJlIGtlcHQgbG93LgoJb3B0aW9uYWwgdWludDMyIHNzcmMgPSAyMDsKfQoKLy8gUmVsYXlzIGluZm9ybWF0aW9uIG9uIHRoZSBiYW5zLiBUaGUgY2xpZW50IG1heSBzZW5kIHRoZSBCYW5MaXN0IG1lc3NhZ2UgdG8KLy8gZWl0aGVyIG1vZGlmeSB0aGUgbGlzdCBvZiBiYW5zIG9yIHF1ZXJ5IHRoZW0gZnJvbSB0aGUgc2VydmVyLiBUaGUgc2VydmVyCi8vIHNlbmRzIHRoaXMgbGlzdCBvbmx5IGFmdGVyIGEgY2xpZW50IHF1ZXJpZXMgZm9yIGl0LgptZXNzYWdlIEJhbkxpc3QgewoJbWVzc2FnZSBCYW5FbnRyeSB7CgkJLy8gQmFubmVkIElQIGFkZHJlc3MuCgkJcmVxdWlyZWQgYnl0ZXMgYWRkcmVzcyA9IDE7CgkJLy8gVGhlIGxlbmd0aCBvZiB0aGUgc3VibmV0IG1hc2sgZm9yIHRoZSBiYW4uCgkJcmVxdWlyZWQgdWludDMyIG1hc2sgPSAyOwoJCS8vIFVzZXIgbmFtZSBmb3IgaWRlbnRpZmljYXRpb24gcHVycG9zZXMgKGRvZXMgbm90IGFmZmVjdCB0aGUgYmFuKS4KCQlvcHRpb25hbCBzdHJpbmcgbmFtZSA9IDM7CgkJLy8gVGhlIGNlcnRpZmljYXRlIGhhc2ggb2YgdGhlIGJhbm5lZCB1c2VyLgoJCW9wdGlvbmFsIHN0cmluZyBoYXNoID0gNDsKCQkvLyBSZWFzb24gZm9yIHRoZSBiYW4gKGRvZXMgbm90IGFmZmVjdCB0aGUgYmFuKS4KCQlvcHRpb25hbCBzdHJpbmcgcmVhc29uID0gNTsKCQkvLyBCYW4gc3RhcnQgdGltZS4KCQlvcHRpb25hbCBzdHJpbmcgc3RhcnQgPSA2OwoJCS8vIEJhbiBkdXJhdGlvbiBpbiBzZWNvbmRzLgoJCW9wdGlvbmFsIHVpbnQzMiBkdXJhdGlvbiA9IDc7Cgl9CgkvLyBMaXN0IG9mIGJhbiBlbnRyaWVzIGN1cnJlbnRseSBpbiBwbGFjZS4KCXJlcGVhdGVkIEJhbkVudHJ5IGJhbnMgPSAxOwoJLy8gVHJ1ZSBpZiB0aGUgc2VydmVyIHNob3VsZCByZXR1cm4gdGhlIGxpc3QsIGZhbHNlIGlmIGl0IHNob3VsZCByZXBsYWNlIG9sZAoJLy8gYmFuIGxpc3Qgd2l0aCB0aGUgb25lIHByb3ZpZGVkLgoJb3B0aW9uYWwgYm9vbCBxdWVyeSA9IDIgW2RlZmF1bHQgPSBmYWxzZV07Cn0KCi8vIFVzZWQgdG8gc2VuZCBhbmQgYnJvYWRjYXN0IHRleHQgbWVzc2FnZXMuCm1lc3NhZ2UgVGV4dE1lc3NhZ2UgewoJLy8gVGhlIG1lc3NhZ2Ugc2VuZGVyLCBpZGVudGlmaWVkIGJ5IGl0cyBzZXNzaW9uLgoJb3B0aW9uYWwgdWludDMyIGFjdG9yID0gMTsKCS8vIFRhcmdldCB1c2VycyBmb3IgdGhlIG1lc3NhZ2UsIGlkZW50aWZpZWQgYnkgdGhlaXIgc2Vzc2lvbi4KCXJlcGVhdGVkIHVpbnQzMiBzZXNzaW9uID0gMjsKCS8vIFRoZSBjaGFubmVscyB0byB3aGljaCB0aGUgbWVzc2FnZSBpcyBzZW50LCBpZGVudGlmaWVkIGJ5IHRoZWlyCgkvLyBjaGFubmVsX2lkcy4KCXJlcGVhdGVkIHVpbnQzMiBjaGFubmVsX2lkID0gMzsKCS8vIFRoZSByb290IGNoYW5uZWxzIHdoZW4gc2VuZGluZyBtZXNzYWdlIHJlY3Vyc2l2ZWx5IHRvIHNldmVyYWwgY2hhbm5lbHMsCgkvLyBpZGVudGlmaWVkIGJ5IHRoZWlyIGNoYW5uZWxfaWRzLgoJcmVwZWF0ZWQgdWludDMyIHRyZWVfaWQgPSA0OwoJLy8gVGhlIFVURi04IGVuY29kZWQgbWVzc2FnZS4gTWF5IGJlIEhUTUwgaWYgdGhlIHNlcnZlciBhbGxvd3MuCglyZXF1aXJlZCBzdHJpbmcgbWVzc2FnZSA9IDU7Cn0KCm1lc3NhZ2UgUGVybWlzc2lvbkRlbmllZCB7CgllbnVtIERlbnlUeXBlIHsKCQkvLyBPcGVyYXRpb24gZGVuaWVkIGZvciBvdGhlciByZWFzb24sIHNlZSByZWFzb24gZmllbGQuCgkJVGV4dCA9IDA7CgkJLy8gUGVybWlzc2lvbnMgd2VyZSBkZW5pZWQuCgkJUGVybWlzc2lvbiA9IDE7CgkJLy8gQ2Fubm90IG1vZGlmeSBTdXBlclVzZXIuCgkJU3VwZXJVc2VyID0gMjsKCQkvLyBJbnZhbGlkIGNoYW5uZWwgbmFtZS4KCQlDaGFubmVsTmFtZSA9IDM7CgkJLy8gVGV4dCBtZXNzYWdlIHRvbyBsb25nLgoJCVRleHRUb29Mb25nID0gNDsKCQkvLyBUaGUgZmx1eCBjYXBhY2l0b3Igd2FzIHNwZWxsZWQgd3JvbmcuCgkJSDlLID0gNTsKCQkvLyBPcGVyYXRpb24gbm90IHBlcm1pdHRlZCBpbiB0ZW1wb3JhcnkgY2hhbm5lbC4KCQlUZW1wb3JhcnlDaGFubmVsID0gNjsKCQkvLyBPcGVyYXRpb24gcmVxdWlyZXMgY2VydGlmaWNhdGUuCgkJTWlzc2luZ0NlcnRpZmljYXRlID0gNzsKCQkvLyBJbnZhbGlkIHVzZXJuYW1lLgoJCVVzZXJOYW1lID0gODsKCQkvLyBDaGFubmVsIGlzIGZ1bGwuCgkJQ2hhbm5lbEZ1bGwgPSA5OwoJCU5lc3RpbmdMaW1pdCA9IDEwOwoJfQoJLy8gVGhlIGRlbmllZCBwZXJtaXNzaW9uIHdoZW4gdHlwZSBpcyBQZXJtaXNzaW9uLgoJb3B0aW9uYWwgdWludDMyIHBlcm1pc3Npb24gPSAxOwoJLy8gY2hhbm5lbF9pZCBmb3IgdGhlIGNoYW5uZWwgd2hlcmUgdGhlIHBlcm1pc3Npb24gd2FzIGRlbmllZCB3aGVuIHR5cGUgaXMKCS8vIFBlcm1pc3Npb24uCglvcHRpb25hbCB1aW50MzIgY2hhbm5lbF9pZCA9IDI7CgkvLyBUaGUgdXNlciB3aG8gd2FzIGRlbmllZCBwZXJtaXNzaW9ucywgaWRlbnRpZmllZCBieSBzZXNzaW9uLgoJb3B0aW9uYWwgdWludDMyIHNlc3Npb24gPSAzOwoJLy8gVGV4dHVhbCByZWFzb24gZm9yIHRoZSBkZW5pYWwuCglvcHRpb25hbCBzdHJpbmcgcmVhc29uID0gNDsKCS8vIFR5cGUgb2YgdGhlIGRlbmlhbC4KCW9wdGlvbmFsIERlbnlUeXBlIHR5cGUgPSA1OwoJLy8gVGhlIG5hbWUgdGhhdCBpcyBpbnZhbGlkIHdoZW4gdHlwZSBpcyBVc2VyTmFtZS4KCW9wdGlvbmFsIHN0cmluZyBuYW1lID0gNjsKfQoKbWVzc2FnZSBBQ0wgewoJbWVzc2FnZSBDaGFuR3JvdXAgewoJCS8vIE5hbWUgb2YgdGhlIGNoYW5uZWwgZ3JvdXAsIFVURi04IGVuY29kZWQuCgkJcmVxdWlyZWQgc3RyaW5nIG5hbWUgPSAxOwoJCS8vIFRydWUgaWYgdGhlIGdyb3VwIGhhcyBiZWVuIGluaGVyaXRlZCBmcm9tIHRoZSBwYXJlbnQgKFJlYWQgb25seSkuCgkJb3B0aW9uYWwgYm9vbCBpbmhlcml0ZWQgPSAyIFtkZWZhdWx0ID0gdHJ1ZV07CgkJLy8gVHJ1ZSBpZiB0aGUgZ3JvdXAgbWVtYmVycyBhcmUgaW5oZXJpdGVkLgoJCW9wdGlvbmFsIGJvb2wgaW5oZXJpdCA9IDMgW2RlZmF1bHQgPSB0cnVlXTsKCQkvLyBUcnVlIGlmIHRoZSBncm91cCBjYW4gYmUgaW5oZXJpdGVkIGJ5IHN1YiBjaGFubmVscy4KCQlvcHRpb25hbCBib29sIGluaGVyaXRhYmxlID0gNCBbZGVmYXVsdCA9IHRydWVdOwoJCS8vIFVzZXJzIGV4cGxpY2l0bHkgaW5jbHVkZWQgaW4gdGhpcyBncm91cCwgaWRlbnRpZmllZCBieSB1c2VyX2lkLgoJCXJlcGVhdGVkIHVpbnQzMiBhZGQgPSA1OwoJCS8vIFVzZXJzIGV4cGxpY2l0bHkgcmVtb3ZlZCBmcm9tIHRoaXMgZ3JvdXAgaW4gdGhpcyBjaGFubmVsIGlmIHRoZSBncm91cAoJCS8vIGhhcyBiZWVuIGluaGVyaXRlZCwgaWRlbnRpZmllZCBieSB1c2VyX2lkLgoJCXJlcGVhdGVkIHVpbnQzMiByZW1vdmUgPSA2OwoJCS8vIFVzZXJzIGluaGVyaXRlZCwgaWRlbnRpZmllZCBieSB1c2VyX2lkLgoJCXJlcGVhdGVkIHVpbnQzMiBpbmhlcml0ZWRfbWVtYmVycyA9IDc7Cgl9CgltZXNzYWdlIENoYW5BQ0wgewoJCS8vIFRydWUgaWYgdGhpcyBBQ0wgYXBwbGllcyB0byB0aGUgY3VycmVudCBjaGFubmVsLgoJCW9wdGlvbmFsIGJvb2wgYXBwbHlfaGVyZSA9IDEgW2RlZmF1bHQgPSB0cnVlXTsKCQkvLyBUcnVlIGlmIHRoaXMgQUNMIGFwcGxpZXMgdG8gdGhlIHN1YiBjaGFubmVscy4KCQlvcHRpb25hbCBib29sIGFwcGx5X3N1YnMgPSAyIFtkZWZhdWx0ID0gdHJ1ZV07CgkJLy8gVHJ1ZSBpZiB0aGUgQUNMIGhhcyBiZWVuIGluaGVyaXRlZCBmcm9tIHRoZSBwYXJlbnQuCgkJb3B0aW9uYWwgYm9vbCBpbmhlcml0ZWQgPSAzIFtkZWZhdWx0ID0gdHJ1ZV07CgkJLy8gSUQgb2YgdGhlIHVzZXIgdGhhdCBpcyBhZmZlY3RlZCBieSB0aGlzIEFDTC4KCQlvcHRpb25hbCB1aW50MzIgdXNlcl9pZCA9IDQ7CgkJLy8gSUQgb2YgdGhlIGdyb3VwIHRoYXQgaXMgYWZmZWN0ZWQgYnkgdGhpcyBBQ0wuCgkJb3B0aW9uYWwgc3RyaW5nIGdyb3VwID0gNTsKCQkvLyBCaXQgZmxhZyBmaWVsZCBvZiB0aGUgcGVybWlzc2lvbnMgZ3JhbnRlZCBieSB0aGlzIEFDTC4KCQlvcHRpb25hbCB1aW50MzIgZ3JhbnQgPSA2OwoJCS8vIEJpdCBmbGFnIGZpZWxkIG9mIHRoZSBwZXJtaXNzaW9ucyBkZW5pZWQgYnkgdGhpcyBBQ0wuCgkJb3B0aW9uYWwgdWludDMyIGRlbnkgPSA3OwoJfQoJLy8gQ2hhbm5lbCBJRCBvZiB0aGUgY2hhbm5lbCB0aGlzIG1lc3NhZ2UgYWZmZWN0cy4KCXJlcXVpcmVkIHVpbnQzMiBjaGFubmVsX2lkID0gMTsKCS8vIFRydWUgaWYgdGhlIGNoYW5uZWwgaW5oZXJpdHMgaXRzIHBhcmVudCdzIEFDTHMuCglvcHRpb25hbCBib29sIGluaGVyaXRfYWNscyA9IDIgW2RlZmF1bHQgPSB0cnVlXTsKCS8vIFVzZXIgZ3JvdXAgc3BlY2lmaWNhdGlvbnMuCglyZXBlYXRlZCBDaGFuR3JvdXAgZ3JvdXBzID0gMzsKCS8vIEFDTCBzcGVjaWZpY2F0aW9ucy4KCXJlcGVhdGVkIENoYW5BQ0wgYWNscyA9IDQ7CgkvLyBUcnVlIGlmIHRoZSBtZXNzYWdlIGlzIGEgcXVlcnkgZm9yIEFDTHMgaW5zdGVhZCBvZiBzZXR0aW5nIHRoZW0uCglvcHRpb25hbCBib29sIHF1ZXJ5ID0gNSBbZGVmYXVsdCA9IGZhbHNlXTsKfQoKLy8gQ2xpZW50IG1heSB1c2UgdGhpcyBtZXNzYWdlIHRvIHJlZnJlc2ggaXRzIHJlZ2lzdGVyZWQgdXNlciBpbmZvcm1hdGlvbi4gVGhlCi8vIGNsaWVudCBzaG91bGQgZmlsbCB0aGUgSURzIG9yIE5hbWVzIG9mIHRoZSB1c2VycyBpdCB3YW50cyB0byByZWZyZXNoLiBUaGUKLy8gc2VydmVyIGZpbGxzIHRoZSBtaXNzaW5nIHBhcnRzIGFuZCBzZW5kcyB0aGUgbWVzc2FnZSBiYWNrLgptZXNzYWdlIFF1ZXJ5VXNlcnMgewoJLy8gdXNlcl9pZHMuCglyZXBlYXRlZCB1aW50MzIgaWRzID0gMTsKCS8vIFVzZXIgbmFtZXMgaW4gdGhlIHNhbWUgb3JkZXIgYXMgaWRzLgoJcmVwZWF0ZWQgc3RyaW5nIG5hbWVzID0gMjsKfQoKLy8gVXNlZCB0byBpbml0aWFsaXplIGFuZCByZXN5bmMgdGhlIFVEUCBlbmNyeXB0aW9uLiBFaXRoZXIgc2lkZSBtYXkgcmVxdWVzdCBhCi8vIHJlc3luYyBieSBzZW5kaW5nIHRoZSBtZXNzYWdlIHdpdGhvdXQgYW55IHZhbHVlcyBmaWxsZWQuIFRoZSByZXN5bmMgaXMKLy8gcGVyZm9ybWVkIGJ5IHNlbmRpbmcgdGhlIG1lc3NhZ2Ugd2l0aCBvbmx5IHRoZSBjbGllbnQgb3Igc2VydmVyIG5vbmNlCi8vIGZpbGxlZC4KbWVzc2FnZSBDcnlwdFNldHVwIHsKCS8vIEVuY3J5cHRpb24ga2V5LgoJb3B0aW9uYWwgYnl0ZXMga2V5ID0gMTsKCS8vIENsaWVudCBub25jZS4KCW9wdGlvbmFsIGJ5dGVzIGNsaWVudF9ub25jZSA9IDI7CgkvLyBTZXJ2ZXIgbm9uY2UuCglvcHRpb25hbCBieXRlcyBzZXJ2ZXJfbm9uY2UgPSAzOwp9CgptZXNzYWdlIENvbnRleHRBY3Rpb25Nb2RpZnkgewoJZW51bSBDb250ZXh0IHsKCQkvLyBBY3Rpb24gaXMgYXBwbGljYWJsZSB0byB0aGUgc2VydmVyLgoJCVNlcnZlciA9IDB4MDE7CgkJLy8gQWN0aW9uIGNhbiB0YXJnZXQgYSBDaGFubmVsLgoJCUNoYW5uZWwgPSAweDAyOwoJCS8vIEFjdGlvbiBjYW4gdGFyZ2V0IGEgVXNlci4KCQlVc2VyID0gMHgwNDsKCX0KCWVudW0gT3BlcmF0aW9uIHsKCQlBZGQgPSAwOwoJCVJlbW92ZSA9IDE7Cgl9CgkvLyBUaGUgYWN0aW9uIG5hbWUuCglyZXF1aXJlZCBzdHJpbmcgYWN0aW9uID0gMTsKCS8vIFRoZSBkaXNwbGF5IG5hbWUgb2YgdGhlIGFjdGlvbi4KCW9wdGlvbmFsIHN0cmluZyB0ZXh0ID0gMjsKCS8vIENvbnRleHQgYml0IGZsYWdzIGRlZmluaW5nIHdoZXJlIHRoZSBhY3Rpb24gc2hvdWxkIGJlIGRpc3BsYXllZC4KCW9wdGlvbmFsIHVpbnQzMiBjb250ZXh0ID0gMzsKCW9wdGlvbmFsIE9wZXJhdGlvbiBvcGVyYXRpb24gPSA0Owp9CgovLyBTZW50IGJ5IHRoZSBjbGllbnQgd2hlbiBpdCB3YW50cyB0byBpbml0aWF0ZSBhIENvbnRleHQgYWN0aW9uLgptZXNzYWdlIENvbnRleHRBY3Rpb24gewoJLy8gVGhlIHRhcmdldCBVc2VyIGZvciB0aGUgYWN0aW9uLCBpZGVudGlmaWVkIGJ5IHNlc3Npb24uCglvcHRpb25hbCB1aW50MzIgc2Vzc2lvbiA9IDE7CgkvLyBUaGUgdGFyZ2V0IENoYW5uZWwgZm9yIHRoZSBhY3Rpb24sIGlkZW50aWZpZWQgYnkgY2hhbm5lbF9pZC4KCW9wdGlvbmFsIHVpbnQzMiBjaGFubmVsX2lkID0gMjsKCS8vIFRoZSBhY3Rpb24gdGhhdCBzaG91bGQgYmUgZXhlY3V0ZWQuCglyZXF1aXJlZCBzdHJpbmcgYWN0aW9uID0gMzsKfQoKLy8gTGlzdHMgdGhlIHJlZ2lzdGVyZWQgdXNlcnMuCm1lc3NhZ2UgVXNlckxpc3QgewoJbWVzc2FnZSBVc2VyIHsKCQkvLyBSZWdpc3RlcmVkIHVzZXIgSUQuCgkJcmVxdWlyZWQgdWludDMyIHVzZXJfaWQgPSAxOwoJCS8vIFJlZ2lzdGVyZWQgdXNlciBuYW1lLgoJCW9wdGlvbmFsIHN0cmluZyBuYW1lID0gMjsKCQlvcHRpb25hbCBzdHJpbmcgbGFzdF9zZWVuID0gMzsKCQlvcHRpb25hbCB1aW50MzIgbGFzdF9jaGFubmVsID0gNDsKCX0KCS8vIEEgbGlzdCBvZiByZWdpc3RlcmVkIHVzZXJzLgoJcmVwZWF0ZWQgVXNlciB1c2VycyA9IDE7Cn0KCi8vIFNlbnQgYnkgdGhlIGNsaWVudCB3aGVuIGl0IHdhbnRzIHRvIHJlZ2lzdGVyIG9yIGNsZWFyIHdoaXNwZXIgdGFyZ2V0cy4KLy8KLy8gTm90ZTogVGhlIGZpcnN0IGF2YWlsYWJsZSB0YXJnZXQgSUQgaXMgMSBhcyAwIGlzIHJlc2VydmVkIGZvciBub3JtYWwKLy8gdGFsa2luZy4gTWF4aW11bSB0YXJnZXQgSUQgaXMgMzAuCm1lc3NhZ2UgVm9pY2VUYXJnZXQgewoJbWVzc2FnZSBUYXJnZXQgewoJCS8vIFVzZXJzIHRoYXQgYXJlIGluY2x1ZGVkIGFzIHRhcmdldHMuCgkJcmVwZWF0ZWQgdWludDMyIHNlc3Npb24gPSAxOwoJCS8vIENoYW5uZWwgdGhhdCBpcyBpbmNsdWRlZCBhcyBhIHRhcmdldC4KCQlvcHRpb25hbCB1aW50MzIgY2hhbm5lbF9pZCA9IDI7CgkJLy8gQUNMIGdyb3VwIHRoYXQgaXMgaW5jbHVkZWQgYXMgYSB0YXJnZXQuCgkJb3B0aW9uYWwgc3RyaW5nIGdyb3VwID0gMzsKCQkvLyBUcnVlIGlmIHRoZSB2b2ljZSBzaG91bGQgZm9sbG93IGxpbmtzIGZyb20gdGhlIHNwZWNpZmllZCBjaGFubmVsLgoJCW9wdGlvbmFsIGJvb2wgbGlua3MgPSA0IFtkZWZhdWx0ID0gZmFsc2VdOwoJCS8vIFRydWUgaWYgdGhlIHZvaWNlIHNob3VsZCBhbHNvIGJlIHNlbnQgdG8gY2hpbGRyZW4gb2YgdGhlIHNwZWNpZmljCgkJLy8gY2hhbm5lbC4KCQlvcHRpb25hbCBib29sIGNoaWxkcmVuID0gNSBbZGVmYXVsdCA9IGZhbHNlXTsKCX0KCS8vIFZvaWNlIHRhcmdldCBJRC4KCW9wdGlvbmFsIHVpbnQzMiBpZCA9IDE7CgkvLyBUaGUgcmVjZWl2ZXJzIHRoYXQgdGhpcyB2b2ljZSB0YXJnZXQgaW5jbHVkZXMuCglyZXBlYXRlZCBUYXJnZXQgdGFyZ2V0cyA9IDI7Cn0KCi8vIFNlbnQgYnkgdGhlIGNsaWVudCB3aGVuIGl0IHdhbnRzIHBlcm1pc3Npb25zIGZvciBhIGNlcnRhaW4gY2hhbm5lbC4gU2VudCBieQovLyB0aGUgc2VydmVyIHdoZW4gaXQgcmVwbGllcyB0byB0aGUgcXVlcnkgb3Igd2FudHMgdGhlIHVzZXIgdG8gcmVzeW5jIGFsbAovLyBjaGFubmVsIHBlcm1pc3Npb25zLgptZXNzYWdlIFBlcm1pc3Npb25RdWVyeSB7CgkvLyBjaGFubmVsX2lkIG9mIHRoZSBjaGFubmVsIGZvciB3aGljaCB0aGUgcGVybWlzc2lvbnMgYXJlIHF1ZXJpZWQuCglvcHRpb25hbCB1aW50MzIgY2hhbm5lbF9pZCA9IDE7CgkvLyBDaGFubmVsIHBlcm1pc3Npb25zLgoJb3B0aW9uYWwgdWludDMyIHBlcm1pc3Npb25zID0gMjsKCS8vIFRydWUgaWYgdGhlIGNsaWVudCBzaG91bGQgZHJvcCBpdHMgY3VycmVudCBwZXJtaXNzaW9uIGluZm9ybWF0aW9uIGZvciBhbGwKCS8vIGNoYW5uZWxzLgoJb3B0aW9uYWwgYm9vbCBmbHVzaCA9IDMgW2RlZmF1bHQgPSBmYWxzZV07Cn0KCi8vIFNlbnQgYnkgdGhlIHNlcnZlciB0byBub3RpZnkgdGhlIHVzZXJzIG9mIHRoZSB2ZXJzaW9uIG9mIHRoZSBDRUxUIGNvZGVjIHRoZXkKLy8gc2hvdWxkIHVzZS4gVGhpcyBtYXkgY2hhbmdlIGR1cmluZyB0aGUgY29ubmVjdGlvbiB3aGVuIG5ldyB1c2VycyBqb2luLgptZXNzYWdlIENvZGVjVmVyc2lvbiB7CgkvLyBUaGUgdmVyc2lvbiBvZiB0aGUgQ0VMVCBBbHBoYSBjb2RlYy4KCXJlcXVpcmVkIGludDMyIGFscGhhID0gMTsKCS8vIFRoZSB2ZXJzaW9uIG9mIHRoZSBDRUxUIEJldGEgY29kZWMuCglyZXF1aXJlZCBpbnQzMiBiZXRhID0gMjsKCS8vIFRydWUgaWYgdGhlIHVzZXIgc2hvdWxkIHByZWZlciBBbHBoYSBvdmVyIEJldGEuCglyZXF1aXJlZCBib29sIHByZWZlcl9hbHBoYSA9IDMgW2RlZmF1bHQgPSB0cnVlXTsKCW9wdGlvbmFsIGJvb2wgb3B1cyA9IDQgW2RlZmF1bHQgPSBmYWxzZV07Cn0KCi8vIFVzZWQgdG8gY29tbXVuaWNhdGUgdXNlciBzdGF0cyBiZXR3ZWVuIHRoZSBzZXJ2ZXIgYW5kIGNsaWVudHMuCm1lc3NhZ2UgVXNlclN0YXRzIHsKCW1lc3NhZ2UgU3RhdHMgewoJCS8vIFRoZSBhbW91bnQgb2YgZ29vZCBwYWNrZXRzIHJlY2VpdmVkLgoJCW9wdGlvbmFsIHVpbnQzMiBnb29kID0gMTsKCQkvLyBUaGUgYW1vdW50IG9mIGxhdGUgcGFja2V0cyByZWNlaXZlZC4KCQlvcHRpb25hbCB1aW50MzIgbGF0ZSA9IDI7CgkJLy8gVGhlIGFtb3VudCBvZiBwYWNrZXRzIG5ldmVyIHJlY2VpdmVkLgoJCW9wdGlvbmFsIHVpbnQzMiBsb3N0ID0gMzsKCQkvLyBUaGUgYW1vdW50IG9mIG5vbmNlIHJlc3luY3MuCgkJb3B0aW9uYWwgdWludDMyIHJlc3luYyA9IDQ7Cgl9CgoJLy8gVXNlciB3aG9zZSBzdGF0cyB0aGVzZSBhcmUuCglvcHRpb25hbCB1aW50MzIgc2Vzc2lvbiA9IDE7CgkvLyBUcnVlIGlmIHRoZSBtZXNzYWdlIGNvbnRhaW5zIG9ubHkgbXV0YWJsZSBzdGF0cyAocGFja2V0cywgcGluZykuCglvcHRpb25hbCBib29sIHN0YXRzX29ubHkgPSAyIFtkZWZhdWx0ID0gZmFsc2VdOwoJLy8gRnVsbCB1c2VyIGNlcnRpZmljYXRlIGNoYWluIG9mIHRoZSB1c2VyIGNlcnRpZmljYXRlIGluIERFUiBmb3JtYXQuCglyZXBlYXRlZCBieXRlcyBjZXJ0aWZpY2F0ZXMgPSAzOwoJLy8gUGFja2V0IHN0YXRpc3RpY3MgZm9yIHBhY2tldHMgcmVjZWl2ZWQgZnJvbSB0aGUgY2xpZW50LgoJb3B0aW9uYWwgU3RhdHMgZnJvbV9jbGllbnQgPSA0OwoJLy8gUGFja2V0IHN0YXRpc3RpY3MgZm9yIHBhY2tldHMgc2VudCBieSB0aGUgc2VydmVyLgoJb3B0aW9uYWwgU3RhdHMgZnJvbV9zZXJ2ZXIgPSA1OwoKCS8vIEFtb3VudCBvZiBVRFAgcGFja2V0cyBzZW50LgoJb3B0aW9uYWwgdWludDMyIHVkcF9wYWNrZXRzID0gNjsKCS8vIEFtb3VudCBvZiBUQ1AgcGFja2V0cyBzZW50LgoJb3B0aW9uYWwgdWludDMyIHRjcF9wYWNrZXRzID0gNzsKCS8vIFVEUCBwaW5nIGF2ZXJhZ2UuCglvcHRpb25hbCBmbG9hdCB1ZHBfcGluZ19hdmcgPSA4OwoJLy8gVURQIHBpbmcgdmFyaWFuY2UuCglvcHRpb25hbCBmbG9hdCB1ZHBfcGluZ192YXIgPSA5OwoJLy8gVENQIHBpbmcgYXZlcmFnZS4KCW9wdGlvbmFsIGZsb2F0IHRjcF9waW5nX2F2ZyA9IDEwOwoJLy8gVENQIHBpbmcgdmFyaWFuY2UuCglvcHRpb25hbCBmbG9hdCB0Y3BfcGluZ192YXIgPSAxMTsKCgkvLyBDbGllbnQgdmVyc2lvbi4KCW9wdGlvbmFsIFZlcnNpb24gdmVyc2lvbiA9IDEyOwoJLy8gQSBsaXN0IG9mIENFTFQgYml0c3RyZWFtIHZlcnNpb24gY29uc3RhbnRzIHN1cHBvcnRlZCBieSB0aGUgY2xpZW50IG9mIHRoaXMKCS8vIHVzZXIuCglyZXBlYXRlZCBpbnQzMiBjZWx0X3ZlcnNpb25zID0gMTM7CgkvLyBDbGllbnQgSVAgYWRkcmVzcy4KCW9wdGlvbmFsIGJ5dGVzIGFkZHJlc3MgPSAxNDsKCS8vIEJhbmR3aXRoIHVzZWQgYnkgdGhpcyBjbGllbnQuCglvcHRpb25hbCB1aW50MzIgYmFuZHdpZHRoID0gMTU7CgkvLyBDb25uZWN0aW9uIGR1cmF0aW9uLgoJb3B0aW9uYWwgdWludDMyIG9ubGluZXNlY3MgPSAxNjsKCS8vIER1cmF0aW9uIHNpbmNlIGxhc3QgYWN0aXZpdHkuCglvcHRpb25hbCB1aW50MzIgaWRsZXNlY3MgPSAxNzsKCS8vIFRydWUgaWYgdGhlIHVzZXIgaGFzIGEgc3Ryb25nIGNlcnRpZmljYXRlLgoJb3B0aW9uYWwgYm9vbCBzdHJvbmdfY2VydGlmaWNhdGUgPSAxOCBbZGVmYXVsdCA9IGZhbHNlXTsKCW9wdGlvbmFsIGJvb2wgb3B1cyA9IDE5IFtkZWZhdWx0ID0gZmFsc2VdOwp9CgovLyBVc2VkIGJ5IHRoZSBjbGllbnQgdG8gcmVxdWVzdCBiaW5hcnkgZGF0YSBmcm9tIHRoZSBzZXJ2ZXIuIEJ5IGRlZmF1bHQgbGFyZ2UKLy8gY29tbWVudHMgb3IgdGV4dHVyZXMgYXJlIG5vdCBzZW50IHdpdGhpbiBzdGFuZGFyZCBtZXNzYWdlcyBidXQgaW5zdGVhZCB0aGUKLy8gaGFzaCBpcy4gSWYgdGhlIGNsaWVudCBkb2VzIG5vdCByZWNvZ25pemUgdGhlIGhhc2ggaXQgbWF5IHJlcXVlc3QgdGhlCi8vIHJlc291cmNlIHdoZW4gaXQgbmVlZHMgaXQuIFRoZSBjbGllbnQgZG9lcyBzbyBieSBzZW5kaW5nIGEgUmVxdWVzdEJsb2IKLy8gbWVzc2FnZSB3aXRoIHRoZSBjb3JyZWN0IGZpZWxkcyBmaWxsZWQgd2l0aCB0aGUgdXNlciBzZXNzaW9ucyBvciBjaGFubmVsX2lkcwovLyBpdCB3YW50cyB0byByZWNlaXZlLiBUaGUgc2VydmVyIHJlcGxpZXMgdG8gdGhpcyBieSBzZW5kaW5nIGEgbmV3Ci8vIFVzZXJTdGF0ZS9DaGFubmVsU3RhdGUgbWVzc2FnZSB3aXRoIHRoZSByZXNvdXJjZXMgZmlsbGVkIGV2ZW4gaWYgdGhleSB3b3VsZAovLyBub3JtYWxseSBiZSB0cmFuc21pdHRlZCBhcyBoYXNoZXMuCm1lc3NhZ2UgUmVxdWVzdEJsb2IgewoJLy8gc2Vzc2lvbnMgb2YgdGhlIHJlcXVlc3RlZCBVc2VyU3RhdGUgdGV4dHVyZXMuCglyZXBlYXRlZCB1aW50MzIgc2Vzc2lvbl90ZXh0dXJlID0gMTsKCS8vIHNlc3Npb25zIG9mIHRoZSByZXF1ZXN0ZWQgVXNlclN0YXRlIGNvbW1lbnRzLgoJcmVwZWF0ZWQgdWludDMyIHNlc3Npb25fY29tbWVudCA9IDI7CgkvLyBjaGFubmVsX2lkcyBvZiB0aGUgcmVxdWVzdGVkIENoYW5uZWxTdGF0ZSBkZXNjcmlwdGlvbnMuCglyZXBlYXRlZCB1aW50MzIgY2hhbm5lbF9kZXNjcmlwdGlvbiA9IDM7Cn0KCi8vIFNlbnQgYnkgdGhlIHNlcnZlciB3aGVuIGl0IGluZm9ybXMgdGhlIGNsaWVudHMgb24gc2VydmVyIGNvbmZpZ3VyYXRpb24KLy8gZGV0YWlscy4KbWVzc2FnZSBTZXJ2ZXJDb25maWcgewoJLy8gVGhlIG1heGltdW0gYmFuZHdpZHRoIHRoZSBjbGllbnRzIHNob3VsZCB1c2UuCglvcHRpb25hbCB1aW50MzIgbWF4X2JhbmR3aWR0aCA9IDE7CgkvLyBTZXJ2ZXIgd2VsY29tZSB0ZXh0LgoJb3B0aW9uYWwgc3RyaW5nIHdlbGNvbWVfdGV4dCA9IDI7CgkvLyBUcnVlIGlmIHRoZSBzZXJ2ZXIgYWxsb3dzIEhUTUwuCglvcHRpb25hbCBib29sIGFsbG93X2h0bWwgPSAzOwoJLy8gTWF4aW11bSB0ZXh0IG1lc3NhZ2UgbGVuZ3RoLgoJb3B0aW9uYWwgdWludDMyIG1lc3NhZ2VfbGVuZ3RoID0gNDsKCS8vIE1heGltdW0gaW1hZ2UgbWVzc2FnZSBsZW5ndGguCglvcHRpb25hbCB1aW50MzIgaW1hZ2VfbWVzc2FnZV9sZW5ndGggPSA1OwoJLy8gVGhlIG1heGltdW0gbnVtYmVyIG9mIHVzZXJzIGFsbG93ZWQgb24gdGhlIHNlcnZlci4KCW9wdGlvbmFsIHVpbnQzMiBtYXhfdXNlcnMgPSA2Owp9CgovLyBTZW50IGJ5IHRoZSBzZXJ2ZXIgdG8gaW5mb3JtIHRoZSBjbGllbnRzIG9mIHN1Z2dlc3RlZCBjbGllbnQgY29uZmlndXJhdGlvbgovLyBzcGVjaWZpZWQgYnkgdGhlIHNlcnZlciBhZG1pbmlzdHJhdG9yLgptZXNzYWdlIFN1Z2dlc3RDb25maWcgewoJLy8gU3VnZ2VzdGVkIGNsaWVudCB2ZXJzaW9uLgoJb3B0aW9uYWwgdWludDMyIHZlcnNpb24gPSAxOwoJLy8gVHJ1ZSBpZiB0aGUgYWRtaW5pc3RyYXRvciBzdWdnZXN0cyBwb3NpdGlvbmFsIGF1ZGlvIHRvIGJlIHVzZWQgb24gdGhpcwoJLy8gc2VydmVyLgoJb3B0aW9uYWwgYm9vbCBwb3NpdGlvbmFsID0gMjsKCS8vIFRydWUgaWYgdGhlIGFkbWluaXN0cmF0b3Igc3VnZ2VzdHMgcHVzaCB0byB0YWxrIHRvIGJlIHVzZWQgb24gdGhpcyBzZXJ2ZXIuCglvcHRpb25hbCBib29sIHB1c2hfdG9fdGFsayA9IDM7Cn0KCi8vIFVzZWQgdG8gZXhjaGFuZ2UgV2ViUlRDIHNlc3Npb24gZGV0YWlscyBiZXR3ZWVuIGNsaWVudCBhbmQgc2VydmVyLgovLyBUaGUgY2xpZW50IG1heSBvbmx5IHNlbmQgdGhlc2UgaWYgaXQgcmVjZWl2ZWQgb25lIGZyb20gdGhlIHNlcnZlciBiZWZvcmVoYW5kLgovLyBUaGUgc2VydmVyIG1heSBvbmx5IHNlbmQgdGhlc2UgaWYgdGhlIGNsaWVudCBoYXMgaW5kaWNhdGVkIGl0cyBzdXBwb3J0IGluCi8vIHRoZSBgd2VicnRjYCBmaWVsZCBvZiB0aGUgYEF1dGhlbnRpY2F0ZWAgbWVzc2FnZSBhbmQsIGlmIHRoZSBzZXJ2ZXIgY2hvb3NlcyB0bwovLyBzdXBwb3J0IFdlYlJUQyBmb3IgdGhlIGNsaWVudCwgaXQgTVVTVCBzZW5kIHRoZSBtZXNzYWdlIHJpZ2h0IGFmdGVyIHJlY2VpdmluZwovLyB0aGUgYEF1dGhlbnRpY2F0ZWAgbWVzc2FnZSwgYmVmb3JlIGFueSBvdGhlciBtZXNzYWdlIChlc3BlY2lhbGx5IGJlZm9yZSBhbnkKLy8gYFVzZXJTdGF0ZWAsIGBUYWxraW5nU3RhdGVgIG9yIGBJY2VDYW5kaWRhdGVgIG1lc3NhZ2VzKS4KLy8KLy8gTm8gYWN0dWFsIFNEUCBpcyBleGNoYW5nZWQsIGl0IGlzIGluc3RlYWQgYnVpbHQgc2VwYXJhdGVseSBieSBib3RoLCB0aGUgY2xpZW50Ci8vIGFuZCB0aGUgc2VydmVyLCBvbiBldmVyeSB1c2VyIGpvaW4vcGFydC4KLy8gQWxsIGF1ZGlvIGlzIGJ1bmRsZWQgdmlhICJhPWdyb3VwOkJVTkRMRSBhdWRpbyRzc3JjIC4uLiIgb3ZlciBhIHNpbmdsZQovLyBEVExTLVNSVFAgb3ZlciBJQ0UgY29ubmVjdGlvbi4KLy8gVGhlIGNsaWVudCBzaG91bGQgYmUgaW4gY29udHJvbGxpbmcgbW9kZSBmb3IgSUNFLCB0aGUgc2VydmVyIHNob3VsZCBhY3QgYXMKLy8gdGhlIHNlcnZlci9wYXNzaXZlIGZvciBEVExTIGFuZCBhcyB0aGUgb2ZmZXJlciBmb3IgV2ViUlRDLgovLyBOb3RlOgovLyAgIFdlYlJUQyBkZW1hbmRzIHRoZSBvZmZlcmVyIHRvIG9mZmVyIGJvdGggYWN0aXZlIGFuZCBwYXNzaXZlIG1vZGVzICJhY3RwYXNzIi4KLy8gICBUaGUgY2xpZW50IHNob3VsZCBtb2RpZnkgdGhlIGJyb3dzZXIncyBhbnN3ZXIgdG8gdXNlIHRoZSBjb3JyZWN0IG9uZSBiZWZvcmUgYXBwbHlpbmcgaXQuCi8vCi8vIEdsb2JhbCBwYXJhbWV0ZXJzIChpY2VfcHdkLCBpY2VfdWZyYWcgYW5kIGR0bHNfZmluZ2VycHJpbnQpIGFyZSBzZW50IHZpYSBhbiBpbml0aWFsCi8vIGBXZWJSVENgIHBhY2tldC4gVHJhbnNtaXR0aW5nIGZ1cnRoZXIgYFdlYlJUQ2AgcGFja2V0cyBzaG91bGQgdHJpZ2dlciBJQ0UtcmVzdGFydHMuCi8vCi8vIFRoZXJlIG5lZWRzIHRvIGJlIG9uZSB1bmlkaXJlY3Rpb25hbCBtZWRpYSBzZWN0aW9uIHBlciBjb25uZWN0ZWQgdXNlci4gVGhlCi8vIFNTUkMgZm9yIGVhY2ggbWVkaWEgc2VjdGlvbiBpcyBzZW50IHdpdGggdGhlIGluaXRpYWwgYFVzZXJTdGF0ZWAgbWVzc2FnZS4KLy8KLy8gU0RQIGZvciBlYWNoIG1lZGlhIHNlZ21lbnQ6Ci8vICAgbT1hdWRpbyAwIFVEUC9UTFMvUlRQL1NBVlBGIDk3Ci8vICAgYz1JTiBJUDQgMC4wLjAuMAovLyAgIGE9ZmluZ2VycHJpbnQ6c2hhLTI1NiAkZHRsc19maW5nZXJwcmludAovLyAgIGE9aWNlLXB3ZDokaWNlX3B3ZAovLyAgIGE9aWNlLXVmcmFnOiRpY2VfdWZyYWcKLy8gICBhPXJ0cG1hcDo5NyBPUFVTLzQ4MDAwLzIKLy8gICBhPXJ0Y3AtbXV4Ci8vICAgYT1zZXR1cDphY3RwYXNzCi8vICAgYT1idW5kbGUtb25seQovLyAgIGE9c3NyYzokc3NyYyBjbmFtZTphdWRpbyRzc3JjCi8vCi8vIFRoZXJlIGFsc28gbmVlZHMgdG8gYmUgb25lIHVuaWRpcmVjdGlvbmFsIG1lZGlhIHNlY3Rpb24gd2hpY2ggZGVzY3JpYmVzCi8vIHRoZSBzdHJlYW0gY29udGFpbmluZyB0aGUgY2xpZW50J3Mgdm9pY2UuIFRoaXMgc2VjdGlvbidzIFNEUCBpcyBzaW1pbGFyCi8vIHRvIHRoZSBhYm92ZSBvbmUgZXhjZXB0IGluIHRoZSBvcHBvc2l0ZSBkaXJlY3Rpb24gKGUuZy4gZGlmZmVyZW50IGljZSBhbmQKLy8gZHRscyBjcmVkZW50aWFscykgdW5kIG5vIHNwZWNpZmljIFNTUkMgKGNvbnNpZGVyaW5nIGhvdyB0aGUgc2VydmVyIGNob29zZXMKLy8gU1NSQ3MgZm9yIGl0cyB1c2VycywgMHhmZmZmZmZmZiBzaG91bGQgYmUgYSBzYWZlIGJldCB0byBwcmV2ZW50IGNvbGxpc2lvbnMpLgptZXNzYWdlIFdlYlJUQyB7CglvcHRpb25hbCBzdHJpbmcgaWNlX3B3ZCA9IDE7CglvcHRpb25hbCBzdHJpbmcgaWNlX3VmcmFnID0gMjsKCW9wdGlvbmFsIHN0cmluZyBkdGxzX2ZpbmdlcnByaW50ID0gMzsKfQoKLy8gVXNlZCB0byBleGNoYW5nZSBJQ0UgY2FuZGlkYXRlcy4KbWVzc2FnZSBJY2VDYW5kaWRhdGUgewoJcmVxdWlyZWQgc3RyaW5nIGNvbnRlbnQgPSAxOwp9CgovLyBJbmRpY2F0ZXMgd2hldGhlciBhIHVzZXIgaXMgY3VycmVudGx5IHRhbGtpbmcgKG9yIHdoaXNwZXJpbmcgb3Igc2hvdXRpbmcpLgovLyBBbHNvIHVzZWQgdG8gc2V0IG93biB0YWxraW5nIHN0YXRlLgovLyBPbmx5IHNlbnQgd2hlbiBXZWJSVEMgaXMgdXNlZCwgb3RoZXJ3aXNlIHRoaXMgaW5mb3JtYXRpb24gY2FuIGJlIGRlZHVjZWQKLy8gZnJvbSB0aGUgVURQIHBhY2tldHMuCm1lc3NhZ2UgVGFsa2luZ1N0YXRlIHsKCS8vIFVzZXIgd2hvc2Ugc3RhdGUgdGhpcyBpcwoJb3B0aW9uYWwgdWludDMyIHNlc3Npb24gPSAxOwoJLy8gVGFyZ2V0LCBhcyB1c2VkIGluIFVEUCBwYWNrZXRzOgoJLy8gQ2xpZW50Ym91bmQ6IDAgaXMgbm9ybWFsIHRhbGtpbmcsIDEgaXMgc2hvdXQsIDIgaXMgd2hpc3BlciwgMzEgaXMgc2VydmVyIGxvb3BiYWNrCgkvLyBTZXJ2ZXJib3VuZDogMCBpcyBub3JtYWwgdGFsa2luZywgMS0zMCBhcyBwZXIgVm9pY2VUYXJnZXQsIDMxIGlzIHNlcnZlciBsb29wYmFjawoJb3B0aW9uYWwgdWludDMyIHRhcmdldCA9IDI7Cn0K","base64");
var messages = protobufjs.loadProto(mumbleProto).build('MumbleProto');

/**
 * Encodes the given message.
 *
 * @param {string} name The name of the message.
 * @param {object} payload The message to be encoded.
 * @return {Buffer} The encoded message.
 */
function encode(name, payload) {
  var encoded = new messages[name](payload || {}).toBuffer();
  // toBuffer returns an ArrayBuffer when called in the browser
  if (!Buffer.isBuffer(encoded)) {
    encoded = Buffer.from(encoded);
  }
	return encoded;
}

/**
 * A message object.
 * @typedef {object} Message
 * @property {string} name - Name of the message
 * @property {object} [payload={}] - Payload of the message
 */

/**
 * Decodes the given message.
 *
 * @param {number} id The id of the message.
 * @param {Buffer} payload The encoded message.
 * @return {object} The decoded message.
 */
function decode(id, payload) {
	var name = nameById[id];
	return new messages[name].decode(payload || {});
}

/**
 * Transform stream for encoding {@link Message Mumble messages}.
 *
 * @constructor
 * @constructs Encoder
 */
function Encoder() {
  // Allow use without new
  if (!(this instanceof Encoder)) return new Encoder();

  Transform.call(this, {
    writableObjectMode: true
  });
}
util.inherits(Encoder, Transform);

Encoder.prototype._transform = function(chunk, encoding, callback) {
  if (typeof chunk.name !== 'string') {
    return callback(new TypeError('chunk.name is not a string'));
  }
  chunk.payload = chunk.payload || {};

  // First, encode the payload
  var data;
  if (chunk.name == 'UDPTunnel') {
    // UDPTunnel message doesn't need encoding
    data = chunk.payload;
  } else {
    try {
      // Encode the message payload
      data = encode(chunk.name, chunk.payload);
    } catch (e) {
      callback(e);
      return;
    }
  }

  // Then create the header
  var header = new Buffer(6);
  header.writeUInt16BE(idByName[chunk.name], 0);
  header.writeUInt32BE(data.length, 2);

  callback(null, Buffer.concat([header, data]));
};

/**
 * Transform stream for decoding {@link Message Mumble messages}.
 *
 * @constructor
 * @constructs Decoder
 */
function Decoder() {
  // Allow use without new
  if (!(this instanceof Decoder)) return new Decoder();

  Transform.call(this, {
    readableObjectMode: true
  });

	this._buffer = new Buffer(1024);
	this._bufferSize = 0;
}
util.inherits(Decoder, Transform);

Decoder.prototype._transform = function(chunk, encoding, callback) {
  // Add incoming chunk to internal buffer
	if (this._buffer.length - this._bufferSize < chunk.length) {
    // Old buffer is too small, replace with bigger one
		var oldBuffer = this._buffer;
		this._buffer = new Buffer(this._bufferSize + chunk.length);
		oldBuffer.copy(this._buffer, 0, 0, this._bufferSize);
	}
	this._bufferSize += chunk.copy(this._buffer, this._bufferSize);


  // Try to decode messages while we still have enough bytes
	while (this._bufferSize >= 6) {
		var type = this._buffer.readUInt16BE(0);
		var size = this._buffer.readUInt32BE(2);
		if (this._bufferSize < 6 + size) {
			break; // Not enough bytes in internal buffer for the expected payload
		}

		var typeName = nameById[type];
		var data = this._buffer.slice(6, 6 + size);
    // Decode payload
		var message;
    if (typeName == 'UDPTunnel') {
      // UDPTunnel payload is not encoded
		  message = new Buffer(data);
    } else {
      try {
		    message = decode(type, data);
      } catch (e) {
        return callback(e);
      }
    }

    // Shift remaining bytes to start of internal buffer
		this._buffer.copy(this._buffer, 0, 6 + size, this._bufferSize);
		this._bufferSize -= 6 + size;

    this.push({
      name: typeName,
      payload: message
    });
	}
  callback();
};

module.exports = {
  Encoder: Encoder,
  Decoder: Decoder,
  messages: messages
};